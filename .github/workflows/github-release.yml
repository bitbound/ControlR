name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: "Mark as pre-release"
        required: true
        type: boolean
        default: false
      run_id:
        description: "Build workflow run ID (leave empty to use latest)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get Latest Build Run ID
        if: inputs.run_id == ''
        id: get-run-id
        run: |
          RUN_ID=$(gh run list --workflow=build.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Using build run ID: $RUN_ID"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download Server Artifact
        uses: actions/download-artifact@v5
        with:
          name: Server
          path: ./server-publish
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download docker-compose file
        uses: actions/download-artifact@v5
        with:
          name: DockerCompose
          path: ./docker-compose-download
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download Build Scripts
        uses: actions/download-artifact@v5
        with:
          name: BuildScripts
          path: ./build-scripts
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download ApiClient NuGet
        uses: actions/download-artifact@v5
        with:
          name: ApiClientNuGet
          path: ./apiclient-nuget
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download macOS Agents
        uses: actions/download-artifact@v5
        with:
          name: Agent-macOS-ARM64
          path: ./macos-agents/arm64
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download macOS x64 Agent
        uses: actions/download-artifact@v5
        with:
          name: Agent-macOS-x64
          path: ./macos-agents/x64
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download macOS DesktopClients
        uses: actions/download-artifact@v5
        with:
          name: DesktopClient-macOS-ARM64
          path: ./macos-desktop/arm64
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Download macOS x64 DesktopClient
        uses: actions/download-artifact@v5
        with:
          name: DesktopClient-macOS-x64
          path: ./macos-desktop/x64
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run-id.outputs.run_id }}

      - name: Get Version from AgentVersion.txt
        id: get-version
        shell: bash
        run: |
          VERSION=$(cat ./server-publish/wwwroot/downloads/AgentVersion.txt)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Release Archives
        shell: bash
        run: |
          # Create server zip
          cd server-publish
          zip -r ../ControlR.Server.${{ steps.get-version.outputs.VERSION }}.zip .
          cd ..

          # Copy docker-compose.yml to root
          cp docker-compose-download/docker-compose.yml ./docker-compose.yml

          # Create macOS Agent archives
          cd macos-agents/arm64
          zip -r ../../ControlR.Agent.macOS-ARM64.${{ steps.get-version.outputs.VERSION }}.zip .
          cd ../x64
          zip -r ../../ControlR.Agent.macOS-x64.${{ steps.get-version.outputs.VERSION }}.zip .
          cd ../..

          # macOS DesktopClient archives (already zipped)
          cp macos-desktop/arm64/ControlR.app.zip ControlR.DesktopClient.macOS-ARM64.${{ steps.get-version.outputs.VERSION }}.zip
          cp macos-desktop/x64/ControlR.app.zip ControlR.DesktopClient.macOS-x64.${{ steps.get-version.outputs.VERSION }}.zip

          # Copy NuGet package
          cp apiclient-nuget/*.nupkg ./

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.get-version.outputs.VERSION }} Release
          tag_name: v${{ steps.get-version.outputs.VERSION }}
          draft: true
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            ControlR.Server.${{ steps.get-version.outputs.VERSION }}.zip
            ControlR.Agent.macOS-ARM64.${{ steps.get-version.outputs.VERSION }}.zip
            ControlR.Agent.macOS-x64.${{ steps.get-version.outputs.VERSION }}.zip
            ControlR.DesktopClient.macOS-ARM64.${{ steps.get-version.outputs.VERSION }}.zip
            ControlR.DesktopClient.macOS-x64.${{ steps.get-version.outputs.VERSION }}.zip
            ControlR.ApiClient.*.nupkg
            docker-compose.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Created
        run: |
          echo "GitHub Release created successfully!"
          echo "Version: v${{ steps.get-version.outputs.VERSION }}"
          echo "Release is in DRAFT mode - review and publish when ready"
