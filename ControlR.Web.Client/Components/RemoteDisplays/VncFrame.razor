@using ControlR.Libraries.Shared.Dtos.RemoteControlDtos
@using ControlR.Libraries.WebSocketRelay.Client
@if (_loading)
{
  <div class="w-100 text-center mt-8">
    <MudText Typo="Typo.h4" Color="Color.Info" GutterBottom>
      Loading
    </MudText>
    <MudProgressCircular Min="0" Max="1" Indeterminate Color="Color.Info" Size="Size.Large" />
  </div>
}
else if (_noVncUri is not null)
{
  <div class="main-grid">
    <div>
      <MudTooltip Text="Reload">
        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                       Color="Color.Primary"
                       OnClick="RequestStreamingSessionFromAgent" />
      </MudTooltip>
    </div>
    <div>
      <iframe class="w-100 h-100" src=@(_noVncUri)></iframe>
    </div>
  </div>
}

@code {
  private bool _loading = true;
  private Uri? _noVncUri;

  [Parameter]
  [EditorRequired]
  public required DeviceViewModel Device { get; init; }

  [CascadingParameter]
  public required DeviceContentInstance ContentInstance { get; init; }

  [CascadingParameter]
  public required DeviceContentWindow ContentWindow { get; init; }

  [Inject]
  public required NavigationManager NavManager { get; init; }

  [Inject]
  public required IHubConnection<IViewerHub> MainHub { get; init; }

  [Inject]
  public required IUserSettingsProvider UserSettings { get; init; }

  [Inject]
  public required IDeviceContentWindowStore WindowStore { get; init; }

  [Inject]
  public required ISnackbar Snackbar { get; init; }

  [Inject]
  public required ITenantSettingsProvider TenantSettings { get; init; }

  [Inject]
  public required ILogger<VncFrame> Logger { get; init; }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    await base.OnAfterRenderAsync(firstRender);

    if (firstRender)
    {
      await RequestStreamingSessionFromAgent();
    }
  }

  private void Close()
  {
    WindowStore.Remove(ContentInstance);
  }

  private async Task RequestStreamingSessionFromAgent()
  {
    try
    {
      _loading = true;
      Snackbar.Add("Connecting", Severity.Info);
      await InvokeAsync(StateHasChanged);

      var sessionId = Guid.NewGuid();
      var accessToken = RandomGenerator.CreateAccessToken();

      var serverUri = new Uri(NavManager.BaseUri).ToWebsocketUri();

      var viewerRelayUri = RelayUriBuilder.Build(
        baseUri: serverUri,
        path: AppConstants.WebSocketRelayPath,
        sessionId: sessionId,
        accessToken: accessToken,
        role: RelayRole.Requester,
        timeoutSeconds: 30);

      var encodedPath = Uri.EscapeDataString(viewerRelayUri.PathAndQuery);

      _noVncUri = new Uri(serverUri,
      $"novnc/vnc.html?path={encodedPath}&resize=scale&autoconnect=true");

      Logger.LogInformation("Resolved NoVNC relay URI: {NoVncUri}", _noVncUri);
      Logger.LogInformation("Creating streaming session.");

      var tenantNotifyUser = await TenantSettings.GetNotifyUserOnSessionStart();
      var notifyUser = tenantNotifyUser ?? await UserSettings.GetNotifyUserOnSessionStart();

      var deviceRelayUri = RelayUriBuilder.Build(
        baseUri: serverUri,
        path: AppConstants.WebSocketRelayPath,
        sessionId: sessionId,
        accessToken: accessToken,
        role: RelayRole.Responder,
        timeoutSeconds: 30);

      Logger.LogInformation("Resolved device relay URI: {DeviceRelayUri}", deviceRelayUri);

      var requestDto = new VncSessionRequestDto(
      sessionId,
      deviceRelayUri,
      MainHub.ConnectionId ?? string.Empty,
      Device.Id,
      notifyUser);

      var sessionResult = await MainHub.Server.RequestVncSession(Device.Id, requestDto);

      if (!sessionResult.IsSuccess)
      {
        Snackbar.Add(sessionResult.Reason, Severity.Error);
        Close();
        return;
      }
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error while requesting streaming session.");
      Snackbar.Add("An error occurred while requesting streaming session", Severity.Error);
    }
    finally
    {
      _loading = false;
      await InvokeAsync(StateHasChanged);
    }
  }
}