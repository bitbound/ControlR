@typeparam THub where THub : class
@inject IHubConnection<THub> HubConnection
@inject IBusyCounter BusyCounter
@inject IMessenger Messenger
@inject AuthenticationStateProvider AuthState

@if (!RendererInfo.IsInteractive || !_isAuthenticated)
{
  <MudIcon Color="Color.Default" Icon="@(Icons.Material.Filled.OfflineBolt)" Class="mx-3 mt-1" Title="Disabled" />
}
else if (_isBusy && _hubConnectionState == HubConnectionState.Connected)
{
  <MudTooltip Text="@($"{_pendingOperations} operation(s) pending")">
    <MudProgressCircular Indeterminate StrokeWidth="6" Size="Size.Small" Color="Color.Success" Class="mx-3 mt-1" />
  </MudTooltip>
}
else
{
  switch (_hubConnectionState)
  {
    case HubConnectionState.Connected:
      if (OperatingSystem.IsBrowser())
      {
        <MudTooltip Text="Connected">
          <MudIcon Color="Color.Success" Icon="@(Icons.Material.Filled.Bolt)" Class="mx-3 mt-1" />
        </MudTooltip>
      }
      else
      {
        <MudTooltip Text="Connected (server-side rendered)">
          <MudIcon Color="Color.Info" Icon="@(Icons.Material.Filled.Bolt)" Class="mx-3 mt-1" />
        </MudTooltip>
      }
      break;
    case HubConnectionState.Connecting or HubConnectionState.Reconnecting:
      <MudTooltip Text="Reconnecting">
        <MudProgressCircular Indeterminate StrokeWidth="6" Size="Size.Small" Color="Color.Warning" Class="mx-3 mt-1" />
      </MudTooltip>
      break;
    case HubConnectionState.Disconnected:
      <MudTooltip Text="Disconnected">
        <MudIcon Color="Color.Error" Icon="@(Icons.Material.Filled.OfflineBolt)" Class="mx-3 mt-1" />
      </MudTooltip>
      break;
  }
}

@code {
  private bool _isBusy;
  private int _pendingOperations;
  private HubConnectionState _hubConnectionState = HubConnectionState.Disconnected;
  private bool _isAuthenticated;

  protected override async Task OnInitializedAsync()
  {
    _isAuthenticated = await AuthState.IsAuthenticated();
    if (RendererInfo.IsInteractive)
    {
      Messenger.RegisterEvent(this, HandleEvent);
      Messenger.Register<HubConnectionStateChangedMessage>(this, HandleHubConnectionStateChanged);
    }
    await base.OnInitializedAsync();
  }

  protected override bool ShouldRender()
  {
    if (RendererInfo.IsInteractive)
    {
      _isBusy = BusyCounter.IsBusy;
      _pendingOperations = BusyCounter.PendingOperations;
      _hubConnectionState = HubConnection.ConnectionState;
    }

    return base.ShouldRender();
  }
  private async Task HandleEvent(object subscriber, Guid eventKind)
  {
    switch (eventKind)
    {
      case var _ when eventKind == EventKinds.PendingOperationsChanged:
        await InvokeAsync(StateHasChanged);
        break;
      default:
        return;
    }
  }

  private async Task HandleHubConnectionStateChanged(object subscriber, HubConnectionStateChangedMessage message)
  {
    _hubConnectionState = message.NewState;
    await InvokeAsync(StateHasChanged);
  }
}