@using ControlR.Libraries.Shared.Enums
@attribute [Route(ClientRoutes.Settings)]
@attribute [Authorize]

@inject ISnackbar Snackbar
@inject IUserSettingsProvider UserSettings
@inject ITenantSettingsProvider TenantSettings
@inject IClipboardManager ClipboardManager
@inject AuthenticationStateProvider AuthState
@inject IMessenger Messenger
@inject IJsInterop JsInterop
@inject ILogger<Settings> Logger

<PageTitle>Settings</PageTitle>

<PrimaryTitle>
  Settings
</PrimaryTitle>

<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Tenant ID
  </MudText>
  <MudTextField T="Guid?"
                Label="Your Tenant ID"
                ReadOnly="true"
                Variant="Variant.Filled"
                AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
                OnAdornmentClick="CopyTenantId"
                Adornment="Adornment.End"
                Value="_tenantId"/>
</div>

<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    User ID
  </MudText>
  <MudTextField T="Guid?"
                Label="Your User ID"
                ReadOnly="true"
                Variant="Variant.Filled"
                AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
                OnAdornmentClick="CopyUserId"
                Adornment="Adornment.End"
                Value="_userId"/>
</div>

<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    User Display Name
  </MudText>
  <MudTextField T="string"
                @bind-Value:get="_userDisplayName"
                @bind-Value:set="SetUserDisplayName"
                MaxLength="25"
                Validation="(string e) => ValidateUsername(e)"
                Label="Shown to partners when connecting">

  </MudTextField>
</div>

<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Show Notification to User
  </MudText>
  
  @if (_tenantNotifySetting.HasValue)
  {
    <MudAlert Severity="Severity.Info" Class="mb-3">
      This setting is being enforced by your tenant administrator.
      @if (_tenantNotifySetting.Value)
      {
        <text>Users will always be notified when remote control sessions start.</text>
      }
      else
      {
        <text>Users will never be notified when remote control sessions start.</text>
      }
    </MudAlert>
  }
  
  <MudCheckBox T="bool"
               @bind-Value:get="_notifyUser"
               @bind-Value:set="SetNotifyUser"
               Disabled="_tenantNotifySetting.HasValue"
               Label="Notify users when a remote control session starts"/>
</div>

<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Theme
  </MudText>

  <MudRadioGroup @bind-Value:get="_themeMode" @bind-Value:set="SetThemeMode" T="ThemeMode">
    <MudRadio Value="@ThemeMode.Auto" Color="Color.Primary">
      <div class="d-flex align-center">
        <MudIcon Icon="@Icons.Material.Filled.Brightness4" Class="me-2" Size="Size.Small" />
        <div>
          <MudText>Auto</MudText>
          <MudText Typo="Typo.caption" Color="Color.Secondary">
            Follows your system preference
          </MudText>
        </div>
      </div>
    </MudRadio>
    <MudRadio Value="@ThemeMode.Light" Color="Color.Primary" Class="mt-2">
      <div class="d-flex align-center">
        <MudIcon Icon="@Icons.Material.Filled.LightMode" Class="me-2" Size="Size.Small" />
        <div>
          <MudText>Light</MudText>
          <MudText Typo="Typo.caption" Color="Color.Secondary">
            Light theme
          </MudText>
        </div>
      </div>
    </MudRadio>
    <MudRadio Value="@ThemeMode.Dark" Color="Color.Primary" Class="mt-2">
      <div class="d-flex align-center">
        <MudIcon Icon="@Icons.Material.Filled.DarkMode" Class="me-2" Size="Size.Small" />
        <div>
          <MudText>Dark</MudText>
          <MudText Typo="Typo.caption" Color="Color.Secondary">
            Dark theme
          </MudText>
        </div>
      </div>
    </MudRadio>
  </MudRadioGroup>
</div>

@code {

  private bool _notifyUser;
  private string _userDisplayName = "";
  private Guid? _tenantId;
  private Guid? _userId;
  private bool? _tenantNotifySetting;
  private ThemeMode _themeMode = ThemeMode.Auto;

  protected override async Task OnInitializedAsync()
  {
    var state = await AuthState.GetAuthenticationStateAsync();
    if (state.User.TryGetTenantId(out var tenantId))
    {
      _tenantId = tenantId;
    }

    if (state.User.TryGetUserId(out var userId))
    {
      _userId = userId;
    }

    // Check if tenant has enforced the notify user setting
    _tenantNotifySetting = await TenantSettings.GetNotifyUserOnSessionStart();

    _notifyUser = await UserSettings.GetNotifyUserOnSessionStart();
    _userDisplayName = await UserSettings.GetUserDisplayName();
    _themeMode = await UserSettings.GetThemeMode();

    // If tenant setting is enforced, override the user setting display
    if (_tenantNotifySetting.HasValue)
    {
      _notifyUser = _tenantNotifySetting.Value;
    }

    await base.OnInitializedAsync();
  }

  private async Task CopyUserId()
  {
    await ClipboardManager.SetText($"{_userId}");
    Snackbar.Add("Copied to clipboard", Severity.Success);
  }

  private async Task CopyTenantId()
  {
    await ClipboardManager.SetText($"{_tenantId}");
    Snackbar.Add("Copied to clipboard", Severity.Success);
  }

  private async Task SetNotifyUser(bool value)
  {
    // Don't allow changes if tenant setting is enforced
    if (_tenantNotifySetting.HasValue)
    {
      return;
    }
    
    _notifyUser = value;
    await UserSettings.SetNotifyUserOnSessionStart(value);
  }

  private async Task SetThemeMode(ThemeMode value)
  {
    _themeMode = value;
    await UserSettings.SetThemeMode(value);
    await Messenger.Send(new ThemeChangedMessage(value));
    Snackbar.Add("Theme updated", Severity.Success);
  }

  private async Task SetUserDisplayName(string value)
  {
    _userDisplayName = value;
    await UserSettings.SetUserDisplayName(value);
    Snackbar.Add("Display name updated", Severity.Success);
  }

  private static string? ValidateUsername(string input)
  {
    if (string.IsNullOrEmpty(input))
    {
      return null;
    }

    if (input.Length > 25)
    {
      return "Username must be 25 characters or less.";
    }

    return Validators.UsernameValidator().IsMatch(input)
      ? "Username can only contain letters, numbers, underscores, and hyphens."
      : null;
  }
}