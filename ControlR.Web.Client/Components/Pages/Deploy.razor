@attribute [Route(RouteNames.Deploy)]

@attribute [Authorize]

@inject NavigationManager NavMan
@inject ISettings Settings
@inject ISnackbar Snackbar
@inject IClipboardManager Clipboard
@inject IBusyCounter BusyCounter
@inject IDeviceGroupsApi DeviceGroupsApi

<PageTitle>Deploy</PageTitle>

<MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom>
  Deploy Scripts
</MudText>

<MudText Typo="Typo.subtitle1" GutterBottom>
  Run these scripts on a remote device to install the agent.
  It will be configured with your public key, allowing you to access the device.
</MudText>


<div class="mt-10">
  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Windows (PowerShell)
  </MudText>

  <MudTextField T="string"
                Label="Copy and paste to install agent"
                Variant="Variant.Filled"
                AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
                OnAdornmentClick="CopyWindowsScript"
                Adornment="Adornment.End"
                Value="WindowsDeployScript"
                Class="mb-5" />

  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Ubuntu (Bash)
  </MudText>

  <MudTextField T="string"
                Label="Copy and paste to install agent"
                Variant="Variant.Filled"
                AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
                OnAdornmentClick="CopyUbuntuScript"
                Adornment="Adornment.End"
                Value="UbuntuDeployScript"
                Class="mb-5" />

  @*     <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
  Mac x64 (zsh)
  </MudText>

  <MudTextField T="string"
  Label="Copy and paste to install agent"
  Variant="Variant.Filled"
  AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
  OnAdornmentClick="CopyMacX64Script"
  Adornment="Adornment.End"
  Value="MacX64DeployScript"
  Class="mb-5" />

  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
  Mac Arm64 (zsh)
  </MudText>

  <MudTextField T="string"
  Label="Copy and paste to install agent"
  Variant="Variant.Filled"
  AdornmentIcon="@(Icons.Material.Filled.ContentCopy)"
  OnAdornmentClick="CopyMacArm64Script"
  Adornment="Adornment.End"
  Value="MacArm64DeployScript"
  Class="mb-5" /> *@

  <MudText Typo="Typo.h6" Color="Color.Primary" GutterBottom>
    Options
  </MudText>

  <div>
    <MudText Typo="Typo.subtitle2" Color="Color.Info">
      Device Group
    </MudText>
    <MudText Typo="Typo.body1" GutterBottom>
      If enabled, the device will be added to the specified group during installation.
    </MudText>
    <MudCheckBox @bind-Value="_addToDeviceGroup" Label="Add to device group" />

    <MudSelect T="DeviceGroupDto" @bind-Value="_selectedDeviceGroup" Disabled="!_addToDeviceGroup" Immediate FullWidth="false" Label="Device Group">
      <MudSelectItem T="DeviceGroupDto" Value="@(null)">
        None
      </MudSelectItem>

      @foreach (var group in _deviceGroups)
      {
        <MudSelectItem Value="@group">
          @(group.Name)
        </MudSelectItem>
      }
    </MudSelect>
  </div>

</div>


@code {
  private bool _addToDeviceGroup;
  private DeviceGroupDto? _selectedDeviceGroup;
  private List<DeviceGroupDto> _deviceGroups = [];

  protected override async Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();

    var result = await DeviceGroupsApi.GetAllDeviceGroups();
    if (result.IsSuccess)
    {
      _deviceGroups = result.Value;
    }
    else
    {
      Snackbar.Add("Failed to get device groups", Severity.Error);     
    }
  }

  private string MacArm64DeployScript
  {
    get
    {
      var downloadUri = new Uri(GetServerUri(), "/downloads/osx-arm64/ControlR.Agent");
      return
        $"sudo rm -f /tmp/ControlR.Agent && " +
        $"sudo curl -o /tmp/ControlR.Agent {downloadUri} && " +
        $"sudo chmod +x /tmp/ControlR.Agent && " +
        $"sudo /tmp/ControlR.Agent install {GetCommonArgs()}";
    }
  }


  private string MacX64DeployScript
  {
    get
    {
      var downloadUri = new Uri(GetServerUri(), "/downloads/osx-x64/ControlR.Agent");
      return
        $"sudo rm -f /tmp/ControlR.Agent && " +
        $"sudo curl -o /tmp/ControlR.Agent {downloadUri} && " +
        $"sudo chmod +x /tmp/ControlR.Agent && " +
        $"sudo /tmp/ControlR.Agent install {GetCommonArgs()}";
    }
  }

  private string UbuntuDeployScript
  {
    get
    {
      var downloadUri = new Uri(GetServerUri(), "/downloads/linux-x64/ControlR.Agent");
      return
          $"sudo rm -f /tmp/ControlR.Agent && " +
          $"sudo wget -q -O /tmp/ControlR.Agent {downloadUri} && " +
          $"sudo chmod +x /tmp/ControlR.Agent && " +
          $"sudo /tmp/ControlR.Agent install {GetCommonArgs()}";
    }
  }

  private string WindowsDeployScript
  {
    get
    {
      var downloadUri = new Uri(GetServerUri(), "/downloads/win-x86/ControlR.Agent.exe");
      return "$ProgressPreference = \"SilentlyContinue\"; " +
          $"Invoke-WebRequest -Uri \"{downloadUri}\" -OutFile \"$env:TEMP/ControlR.Agent.exe\" -UseBasicParsing; " +
          $"Start-Process -FilePath \"$env:TEMP/ControlR.Agent.exe\" -ArgumentList \"install {GetCommonArgs()}\" -Verb RunAs;";
    }
  }

  private async Task CopyMacArm64Script()
  {
    await Clipboard.SetText(MacArm64DeployScript);
    Snackbar.Add("Install script copied to clipboard", Severity.Success);
  }

  private async Task CopyMacX64Script()
  {
    await Clipboard.SetText(MacX64DeployScript);
    Snackbar.Add("Install script copied to clipboard", Severity.Success);
  }

  private async Task CopyUbuntuScript()
  {
    await Clipboard.SetText(UbuntuDeployScript);
    Snackbar.Add("Install script copied to clipboard", Severity.Success);
  }

  private async Task CopyWindowsScript()
  {
    await Clipboard.SetText(WindowsDeployScript);
    Snackbar.Add("Install script copied to clipboard", Severity.Success);
  }

  private string GetCommonArgs()
  {
    var serverUri = GetServerUri();
    var args = $"-s {NavMan.Uri} -i {serverUri.Authority}";
    if (_addToDeviceGroup && _selectedDeviceGroup is not null)
    {
      args += $" -g {_selectedDeviceGroup.Uid}";
    }

    return args;
  }

  private Uri GetServerUri()
  {
    return new Uri(NavMan.Uri);
  }
}
